\doxysection{tube\+\_\+compressor\+\_\+node.\+hpp}
\hypertarget{tube__compressor__node_8hpp_source}{}\label{tube__compressor__node_8hpp_source}\index{src/engine/tube\_compressor\_node.hpp@{src/engine/tube\_compressor\_node.hpp}}
\doxymbox{\hyperlink{tube__compressor__node_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#ifndef\ TUBE\_COMPRESSOR\_NODE\_HPP}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#define\ TUBE\_COMPRESSOR\_NODE\_HPP}}
\DoxyCodeLine{00003\ }
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}\doxymbox{\hyperlink{flux__plugin_8hpp}{flux\_plugin.hpp}}"{}}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}\doxymbox{\hyperlink{dsp__utils_8hpp}{dsp\_utils.hpp}}"{}}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <cmath>}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{keyword}{namespace\ }\doxymbox{\hyperlink{namespace_beam}{Beam}}\ \{}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00014\ \textcolor{keyword}{class\ }\doxymbox{\hyperlink{class_beam_1_1_tube_compressor_node_ade6305b73ac3df1d1e35a403d18eb834}{TubeCompressorNode}}\ :\ \textcolor{keyword}{public}\ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a9d91b56960799fdbfc4575e2fcfa6689}{FluxPlugin}}\ \{}
\DoxyCodeLine{00015\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00016\ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_tube_compressor_node_ade6305b73ac3df1d1e35a403d18eb834}{TubeCompressorNode}}(\textcolor{keywordtype}{int}\ bufferSize,\ \textcolor{keywordtype}{float}\ sampleRate)\ }
\DoxyCodeLine{00017\ \ \ \ \ \ \ \ \ :\ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a9d91b56960799fdbfc4575e2fcfa6689}{FluxPlugin}}(\textcolor{stringliteral}{"{}Tube\ Comp"{}},\ bufferSize,\ sampleRate)\ }
\DoxyCodeLine{00018\ \ \ \ \ \{}
\DoxyCodeLine{00019\ \ \ \ \ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a1768cc84018f8de19bcbf781e9b7ac3f}{addParam}}(\textcolor{stringliteral}{"{}Threshold"{}},\ -\/60.0f,\ 0.0f,\ -\/20.0f);}
\DoxyCodeLine{00020\ \ \ \ \ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a1768cc84018f8de19bcbf781e9b7ac3f}{addParam}}(\textcolor{stringliteral}{"{}Ratio"{}},\ 1.0f,\ 20.0f,\ 4.0f);}
\DoxyCodeLine{00021\ \ \ \ \ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a1768cc84018f8de19bcbf781e9b7ac3f}{addParam}}(\textcolor{stringliteral}{"{}Attack"{}},\ 1.0f,\ 100.0f,\ 10.0f);}
\DoxyCodeLine{00022\ \ \ \ \ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a1768cc84018f8de19bcbf781e9b7ac3f}{addParam}}(\textcolor{stringliteral}{"{}Release"{}},\ 10.0f,\ 500.0f,\ 100.0f);}
\DoxyCodeLine{00023\ \ \ \ \ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a1768cc84018f8de19bcbf781e9b7ac3f}{addParam}}(\textcolor{stringliteral}{"{}Drive"{}},\ 0.0f,\ 12.0f,\ 0.0f);\ \textcolor{comment}{//\ Tube\ Saturation}}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00025\ \ \ \ \ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_tube_compressor_node_ab7fd9e455ecf656fc2c99bc0b8d2b8a2}{m\_envelope}}.store(0.0f);}
\DoxyCodeLine{00026\ \ \ \ \ \}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \ \ \ \ \textcolor{keywordtype}{void}\ \doxymbox{\hyperlink{class_beam_1_1_tube_compressor_node_a45c3b4af658365cf72b55a961abd479a}{processBlock}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{float}*\ input,\ \textcolor{keywordtype}{float}*\ output,\ \textcolor{keywordtype}{int}\ totalSamples)\textcolor{keyword}{\ override\ }\{}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ threshDB\ =\ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a1b292b033caaaf9ec67154dfee2e577b}{getParam}}(\textcolor{stringliteral}{"{}Threshold"{}});}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ ratio\ =\ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a1b292b033caaaf9ec67154dfee2e577b}{getParam}}(\textcolor{stringliteral}{"{}Ratio"{}});}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ attack\ =\ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a1b292b033caaaf9ec67154dfee2e577b}{getParam}}(\textcolor{stringliteral}{"{}Attack"{}})\ *\ 0.001f;}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ release\ =\ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a1b292b033caaaf9ec67154dfee2e577b}{getParam}}(\textcolor{stringliteral}{"{}Release"{}})\ *\ 0.001f;}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ drive\ =\ std::pow(10.0f,\ \doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a1b292b033caaaf9ec67154dfee2e577b}{getParam}}(\textcolor{stringliteral}{"{}Drive"{}})\ /\ 20.0f);}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ attCoef\ =\ std::exp(-\/1.0f\ /\ (\doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a3e65f35944360e4e6ac370a967cf5eb3}{getSampleRate}}()\ *\ attack));}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ relCoef\ =\ std::exp(-\/1.0f\ /\ (\doxymbox{\hyperlink{class_beam_1_1_flux_plugin_a3e65f35944360e4e6ac370a967cf5eb3}{getSampleRate}}()\ *\ release));}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ totalSamples;\ ++i)\ \{}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ in\ =\ input[i];}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ absIn\ =\ std::abs(in);}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Ballistics}}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ env\ =\ \doxymbox{\hyperlink{class_beam_1_1_tube_compressor_node_ab7fd9e455ecf656fc2c99bc0b8d2b8a2}{m\_envelope}}.load();}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (absIn\ >\ env)\ env\ =\ attCoef\ *\ env\ +\ (1.0f\ -\/\ attCoef)\ *\ absIn;}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ env\ =\ relCoef\ *\ env\ +\ (1.0f\ -\/\ relCoef)\ *\ absIn;}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_tube_compressor_node_ab7fd9e455ecf656fc2c99bc0b8d2b8a2}{m\_envelope}}.store(env);}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Gain\ Reduction}}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ envDB\ =\ 20.0f\ *\ std::log10(env\ +\ 1e-\/9f);}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ gainDB\ =\ 0.0f;}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (envDB\ >\ threshDB)\ \{}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ gainDB\ =\ (threshDB\ -\/\ envDB)\ *\ (1.0f\ -\/\ 1.0f\ /\ ratio);}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ gain\ =\ std::pow(10.0f,\ gainDB\ /\ 20.0f);}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ out\ =\ in\ *\ gain;}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Tube\ Saturation\ (Soft\ Clip)}}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \ \ \ \ out\ *=\ drive;}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \ \ \ \ out\ =\ std::tanh(out);\ }
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \ \ \ \ output[i]\ =\ \doxymbox{\hyperlink{namespace_beam_aa7334dd3aa681f0530ad4fdc9b379103}{flush\_denormal}}(out);}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00064\ \ \ \ \ \}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00067\ \ \ \ \ std::atomic<float>\ \doxymbox{\hyperlink{class_beam_1_1_tube_compressor_node_ab7fd9e455ecf656fc2c99bc0b8d2b8a2}{m\_envelope}};}
\DoxyCodeLine{00068\ \};}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \}\ \textcolor{comment}{//\ namespace\ Beam}}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ TUBE\_COMPRESSOR\_NODE\_HPP}}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ }

\end{DoxyCode}
