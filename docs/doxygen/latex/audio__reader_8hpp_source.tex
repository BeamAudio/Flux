\doxysection{audio\+\_\+reader.\+hpp}
\hypertarget{audio__reader_8hpp_source}{}\label{audio__reader_8hpp_source}\index{src/engine/audio\_reader.hpp@{src/engine/audio\_reader.hpp}}
\doxymbox{\hyperlink{audio__reader_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#ifndef\ AUDIO\_READER\_HPP}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#define\ AUDIO\_READER\_HPP}}
\DoxyCodeLine{00003\ }
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <string>}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <mutex>}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <algorithm>}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}../../third\_party/miniaudio.h"{}}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{keyword}{namespace\ }\doxymbox{\hyperlink{namespace_beam}{Beam}}\ \{}
\DoxyCodeLine{00011\ }
\DoxyCodeLine{00017\ \textcolor{keyword}{class\ }\doxymbox{\hyperlink{class_beam_1_1_audio_reader_ae4a56c5f148770c773af2a9fb420310a}{AudioReader}}\ \{}
\DoxyCodeLine{00018\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00019\ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_ae4a56c5f148770c773af2a9fb420310a}{AudioReader}}()\ :\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a6d9fca276cd0aef64371cee9d9bac9fb}{m\_isInitialized}}(false)\ \{\}}
\DoxyCodeLine{00020\ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a21636c4b3318702dfd8ee9a44673ab7a}{\string~AudioReader}}()\ \{\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a77131e7bd2db6d44ae899de90f4fb9d4}{close}}();\ \}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \ \ \ \ \textcolor{keywordtype}{bool}\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a9b7d56e818f7713f66dc7034ef4ec2f6}{open}}(\textcolor{keyword}{const}\ std::string\&\ filePath,\ \textcolor{keywordtype}{int}\ targetChannels\ =\ 2)\ \{}
\DoxyCodeLine{00023\ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock(\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a3536c1167f89c47f55d5f438395c02a2}{m\_mutex}});}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a77131e7bd2db6d44ae899de90f4fb9d4}{close}}();}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ ma\_decoder\_config\ config\ =\ ma\_decoder\_config\_init(ma\_format\_f32,\ (ma\_uint32)targetChannels,\ 0);\ }
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ ma\_result\ result\ =\ ma\_decoder\_init\_file(filePath.c\_str(),\ \&config,\ \&\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}});}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ MA\_SUCCESS)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a6d9fca276cd0aef64371cee9d9bac9fb}{m\_isInitialized}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00033\ \ \ \ \ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{keywordtype}{void}\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a77131e7bd2db6d44ae899de90f4fb9d4}{close}}()\ \{}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a6d9fca276cd0aef64371cee9d9bac9fb}{m\_isInitialized}})\ \{}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \ \ \ \ ma\_decoder\_uninit(\&\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}});}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \ \ \ \ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a6d9fca276cd0aef64371cee9d9bac9fb}{m\_isInitialized}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00040\ \ \ \ \ \}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_adc6266eb0274d4e1449f1c70391a3b7e}{readFrames}}(\textcolor{keywordtype}{float}*\ buffer,\ \textcolor{keywordtype}{size\_t}\ frames,\ \textcolor{keywordtype}{int}\ destChannels)\ \{}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock(\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a3536c1167f89c47f55d5f438395c02a2}{m\_mutex}});}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a6d9fca276cd0aef64371cee9d9bac9fb}{m\_isInitialized}})\ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ ma\_uint64\ framesRead\ =\ 0;}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ ma\_decoder\_read\_pcm\_frames(\&\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}},\ buffer,\ frames,\ \&framesRead);}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{size\_t})framesRead;}
\DoxyCodeLine{00049\ \ \ \ \ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \ \ \ \ \textcolor{keywordtype}{void}\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1fa33f3e75524650944a9570b08ca533}{seek}}(\textcolor{keywordtype}{size\_t}\ frame)\ \{}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock(\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a3536c1167f89c47f55d5f438395c02a2}{m\_mutex}});}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a6d9fca276cd0aef64371cee9d9bac9fb}{m\_isInitialized}})\ \{}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \ \ \ \ ma\_decoder\_seek\_to\_pcm\_frame(\&\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}},\ frame);}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00056\ \ \ \ \ \}}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \ \ \ \ uint32\_t\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_afead01b7db78e8e597b2d527f5375680}{getSampleRate}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a6d9fca276cd0aef64371cee9d9bac9fb}{m\_isInitialized}}\ ?\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}}.outputSampleRate\ :\ 0;\ \}}
\DoxyCodeLine{00059\ \ \ \ \ uint32\_t\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a7916ff1975fb3596ffd6418716c18563}{getChannels}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a6d9fca276cd0aef64371cee9d9bac9fb}{m\_isInitialized}}\ ?\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}}.outputChannels\ :\ 0;\ \}}
\DoxyCodeLine{00060\ \ \ \ \ }
\DoxyCodeLine{00061\ \ \ \ \ uint64\_t\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_aadf285f15de29c86b809762174cffc5a}{getTotalFrames}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a6d9fca276cd0aef64371cee9d9bac9fb}{m\_isInitialized}})\ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ ma\_uint64\ length\ =\ 0;}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ ma\_decoder\_get\_length\_in\_pcm\_frames(\textcolor{keyword}{const\_cast<}ma\_decoder*\textcolor{keyword}{>}(\&\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}}),\ \&length);}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ length;}
\DoxyCodeLine{00066\ \ \ \ \ \}}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \ \ std::vector<std::vector<float>>\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_ade48fa4295efbeda7fb10cd8f4e06551}{getPeakData}}(\textcolor{keywordtype}{int}\ numPoints)\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock(\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a3536c1167f89c47f55d5f438395c02a2}{m\_mutex}});}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a6d9fca276cd0aef64371cee9d9bac9fb}{m\_isInitialized}}\ ||\ numPoints\ <=\ 0)\ \textcolor{keywordflow}{return}\ \{\};}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ uint64\_t\ totalFrames\ =\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_aadf285f15de29c86b809762174cffc5a}{getTotalFrames}}();}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ channels\ =\ (int)\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}}.outputChannels;}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (totalFrames\ ==\ 0)\ \textcolor{keywordflow}{return}\ std::vector<std::vector<float>>(channels,\ std::vector<float>(numPoints,\ 0.0f));}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ uint64\_t\ framesPerPoint\ =\ totalFrames\ /\ numPoints;}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (framesPerPoint\ ==\ 0)\ framesPerPoint\ =\ 1;}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ std::vector<std::vector<float>>\ allPeaks(channels,\ std::vector<float>(numPoints,\ 0.0f));}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ ma\_uint64\ originalPos\ =\ 0;}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ ma\_decoder\_get\_cursor\_in\_pcm\_frames(\&\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}},\ \&originalPos);}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ ma\_decoder\_seek\_to\_pcm\_frame(\&\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}},\ 0);}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ CHUNK\_SIZE\ =\ 4096;}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ std::vector<float>\ chunk(CHUNK\_SIZE\ *\ channels);}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ numPoints;\ ++i)\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ uint64\_t\ remaining\ =\ framesPerPoint;}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}(remaining\ >\ 0)\ \{}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ toRead\ =\ (size\_t)(std::min)((uint64\_t)CHUNK\_SIZE,\ remaining);}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ma\_uint64\ read\ =\ 0;}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ma\_decoder\_read\_pcm\_frames(\&\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}},\ chunk.data(),\ toRead,\ \&read);}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (read\ ==\ 0)\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (ma\_uint64\ f\ =\ 0;\ f\ <\ read;\ ++f)\ \{}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ c\ =\ 0;\ c\ <\ channels;\ ++c)\ \{}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ v\ =\ std::abs(chunk[f\ *\ channels\ +\ c]);}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (v\ >\ allPeaks[c][i])\ allPeaks[c][i]\ =\ v;}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ remaining\ -\/=\ read;}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ ma\_decoder\_seek\_to\_pcm\_frame(\&\doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}},\ originalPos);}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ allPeaks;}
\DoxyCodeLine{00108\ \ \ \ \ \}}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00111\ \ \ \ \ ma\_decoder\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a1ed857bef5848ff75653fea75d1e7c51}{m\_decoder}};}
\DoxyCodeLine{00112\ \ \ \ \ \textcolor{keywordtype}{bool}\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a6d9fca276cd0aef64371cee9d9bac9fb}{m\_isInitialized}};}
\DoxyCodeLine{00113\ \ \ \ \ std::mutex\ \doxymbox{\hyperlink{class_beam_1_1_audio_reader_a3536c1167f89c47f55d5f438395c02a2}{m\_mutex}};}
\DoxyCodeLine{00114\ \};}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \}\ \textcolor{comment}{//\ namespace\ Beam}}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ AUDIO\_READER\_HPP}}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ }

\end{DoxyCode}
