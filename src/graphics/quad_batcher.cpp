#include "quad_batcher.hpp"
#include "shader.hpp"
#include <iostream>
#include <cmath>
#include <algorithm>

namespace Beam {

// Simple 8x8 bitmapped font data for a few ASCII characters
static const unsigned char FONT_DATA[95][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // space
    {0x18,0x3c,0x3c,0x18,0x18,0x00,0x18,0x00}, // !
    {0x6c,0x6c,0x6c,0x00,0x00,0x00,0x00,0x00}, // "
    {0x6c,0x6c,0xfe,0x6c,0xfe,0x6c,0x6c,0x00}, // #
    {0x18,0x7e,0xc0,0x7c,0x06,0xfc,0x18,0x00}, // $
    {0x00,0xc6,0xcc,0x18,0x30,0x66,0xc6,0x00}, // %
    {0x38,0x6c,0x38,0x76,0xdc,0xcc,0x76,0x00}, // &
    {0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00}, // '
    {0x18,0x30,0x60,0x60,0x60,0x30,0x18,0x00}, // (
    {0x60,0x30,0x18,0x18,0x18,0x30,0x60,0x00}, // )
    {0x00,0x66,0x3c,0xff,0x3c,0x66,0x00,0x00}, // *
    {0x00,0x18,0x18,0x7e,0x18,0x18,0x00,0x00}, // +
    {0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x60}, // ,
    {0x00,0x00,0x00,0x7e,0x00,0x00,0x00,0x00}, // -
    {0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00}, // .
    {0x06,0x0c,0x18,0x30,0x60,0xc0,0x80,0x00}, // /
    {0x7c,0xc6,0xce,0xde,0xf6,0xe6,0x7c,0x00}, // 0
    {0x30,0x70,0x30,0x30,0x30,0x30,0xfc,0x00}, // 1
    {0x7c,0xc6,0x06,0x0c,0x18,0x30,0xfe,0x00}, // 2
    {0x7c,0xc6,0x06,0x3c,0x06,0xc6,0x7c,0x00}, // 3
    {0x1c,0x3c,0x6c,0xcc,0xfe,0x0c,0x1e,0x00}, // 4
    {0xfe,0xc0,0xc0,0xfc,0x06,0xc6,0x7c,0x00}, // 5
    {0x38,0x60,0xc0,0xfc,0xc6,0xc6,0x7c,0x00}, // 6
    {0xfe,0x06,0x0c,0x18,0x30,0x30,0x30,0x00}, // 7
    {0x7c,0xc6,0xc6,0x7c,0xc6,0xc6,0x7c,0x00}, // 8
    {0x7c,0xc6,0xc6,0x7e,0x06,0x0c,0x78,0x00}, // 9
    {0x00,0x30,0x30,0x00,0x30,0x30,0x00,0x00}, // :
    {0x00,0x30,0x30,0x00,0x30,0x30,0x60,0x00}, // ;
    {0x18,0x30,0x60,0xc0,0x60,0x30,0x18,0x00}, // <
    {0x00,0x00,0x7e,0x00,0x7e,0x00,0x00,0x00}, // =
    {0x60,0x30,0x18,0x0c,0x18,0x30,0x60,0x00}, // >
    {0x7c,0xc6,0x0c,0x18,0x18,0x00,0x18,0x00}, // ?
    {0x7c,0xc6,0xde,0xde,0xde,0xc0,0x78,0x00}, // @
    {0x38,0x6c,0xc6,0xfe,0xc6,0xc6,0xc6,0x00}, // A
    {0xfc,0x66,0x66,0x7c,0x66,0x66,0xfc,0x00}, // B
    {0x3c,0x66,0xc0,0xc0,0xc0,0x66,0x3c,0x00}, // C
    {0xf8,0x6c,0x66,0x66,0x66,0x6c,0xf8,0x00}, // D
    {0xfe,0x62,0x68,0x78,0x68,0x62,0xfe,0x00}, // E
    {0xfe,0x62,0x68,0x78,0x68,0x60,0xf0,0x00}, // F
    {0x3c,0x66,0xc0,0xc0,0xce,0x66,0x3e,0x00}, // G
    {0xc6,0xc6,0xc6,0xfe,0xc6,0xc6,0xc6,0x00}, // H
    {0x3c,0x18,0x18,0x18,0x18,0x18,0x3c,0x00}, // I
    {0x1e,0x0c,0x0c,0x0c,0x0c,0xcc,0x78,0x00}, // J
    {0xe6,0x66,0x6c,0x78,0x6c,0x66,0xe6,0x00}, // K
    {0xf0,0x60,0x60,0x60,0x62,0x66,0xfe,0x00}, // L
    {0xc6,0xee,0xfe,0xfe,0xd6,0xc6,0xc6,0x00}, // M
    {0xc6,0xe6,0xf6,0xde,0xce,0xc6,0xc6,0x00}, // N
    {0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00}, // O
    {0xfc,0x66,0x66,0x7c,0x60,0x60,0xf0,0x00}, // P
    {0x7c,0xc6,0xc6,0xc6,0xd6,0xcc,0x7e,0x00}, // Q
    {0xfc,0x66,0x66,0x7c,0x6c,0x66,0xe6,0x00}, // R
    {0x7c,0xc6,0x60,0x38,0x0c,0xc6,0x7c,0x00}, // S
    {0x7e,0x18,0x18,0x18,0x18,0x18,0x3c,0x00}, // T
    {0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00}, // U
    {0xc6,0xc6,0xc6,0xc6,0xc6,0x6c,0x38,0x00}, // V
    {0xc6,0xc6,0xc6,0xd6,0xfe,0xee,0xc6,0x00}, // W
    {0xc6,0xc6,0x6c,0x38,0x6c,0xc6,0xc6,0x00}, // X
    {0xc6,0xc6,0x6c,0x38,0x18,0x18,0x3c,0x00}, // Y
    {0xfe,0x06,0x0c,0x18,0x30,0x60,0xfe,0x00}, // Z
    {0x3c,0x30,0x30,0x30,0x30,0x30,0x3c,0x00}, // [
    {0xc0,0x60,0x30,0x18,0x0c,0x06,0x02,0x00}, // backward slash
    {0x3c,0x0c,0x0c,0x0c,0x0c,0x0c,0x3c,0x00}, // ]
    {0x10,0x38,0x6c,0xc6,0x00,0x00,0x00,0x00}, // ^
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff}, // _
    {0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00}, // `
    {0x00,0x00,0x78,0x0c,0x7c,0xcc,0x76,0x00}, // a
    {0xe0,0x60,0x7c,0x66,0x66,0x66,0x7c,0x00}, // b
    {0x00,0x00,0x3c,0x66,0x60,0x66,0x3c,0x00}, // c
    {0x1c,0x0c,0x7c,0xcc,0xcc,0xcc,0x76,0x00}, // d
    {0x00,0x00,0x7c,0xc6,0xfe,0x60,0x3c,0x00}, // e
    {0x1c,0x30,0x7c,0x30,0x30,0x30,0x30,0x00}, // f
    {0x00,0x00,0x76,0xcc,0xcc,0x7c,0x0c,0xf8}, // g
    {0xe0,0x60,0x6c,0x76,0x66,0x66,0x66,0x00}, // h
    {0x18,0x00,0x38,0x18,0x18,0x18,0x3c,0x00}, // i
    {0x06,0x00,0x06,0x06,0x06,0x66,0x3c,0x00}, // j
    {0xe0,0x60,0x66,0x6c,0x78,0x6c,0x66,0x00}, // k
    {0x38,0x18,0x18,0x18,0x18,0x18,0x3c,0x00}, // l
    {0x00,0x00,0xec,0xfe,0xd6,0xd6,0xd6,0x00}, // m
    {0x00,0x00,0xdc,0x66,0x66,0x66,0x66,0x00}, // n
    {0x00,0x00,0x7c,0xc6,0xc6,0xc6,0x7c,0x00}, // o
    {0x00,0x00,0x7c,0x66,0x66,0x7c,0x60,0xf0}, // p
    {0x00,0x00,0x76,0xcc,0xcc,0x7c,0x0c,0x1e}, // q
    {0x00,0x00,0xdc,0x76,0x60,0x60,0xf0,0x00}, // r
    {0x00,0x00,0x7c,0xc0,0x78,0x06,0xfc,0x00}, // s
    {0x30,0x30,0xfc,0x30,0x30,0x30,0x1c,0x00}, // t
    {0x00,0x00,0xcc,0xcc,0xcc,0xcc,0x76,0x00}, // u
    {0x00,0x00,0xcc,0xcc,0xcc,0x78,0x30,0x00}, // v
    {0x00,0x00,0xc6,0xd6,0xd6,0xfe,0x6c,0x00}, // w
    {0x00,0x00,0xc6,0x6c,0x38,0x6c,0xc6,0x00}, // x
    {0x00,0x00,0xc6,0xc6,0xc6,0x7e,0x06,0xfc}, // y
    {0x00,0x00,0xfe,0x0c,0x18,0x30,0xfe,0x00}, // z
    {0x0c,0x18,0x18,0x70,0x18,0x18,0x0c,0x00}, // {
    {0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00}, // |
    {0x30,0x18,0x18,0x0e,0x18,0x18,0x30,0x00}, // }
    {0x00,0x00,0x00,0x76,0xdc,0x00,0x00,0x00}  // ~
};

QuadBatcher::QuadBatcher(size_t maxQuads) : m_maxQuads(maxQuads), m_quadCount(0) {
    m_vertices.reserve(maxQuads * 4);

    glGenVertexArrays(1, &m_vao);
    glGenBuffers(1, &m_vbo);
    glGenBuffers(1, &m_ibo);

    glBindVertexArray(m_vao);

    glBindBuffer(GL_ARRAY_BUFFER, m_vbo);
    glBufferData(GL_ARRAY_BUFFER, maxQuads * 4 * sizeof(Vertex), nullptr, GL_DYNAMIC_DRAW);

    // Positions
    glEnableVertexAttribArray(0);
    glVertexAttribPointer(0, 2, GL_FLOAT, GL_FALSE, sizeof(Vertex), (const void*)0);
    // TexCoords
    glEnableVertexAttribArray(1);
    glVertexAttribPointer(1, 2, GL_FLOAT, GL_FALSE, sizeof(Vertex), (const void*)(2 * sizeof(float)));
    // Colors
    glEnableVertexAttribArray(2);
    glVertexAttribPointer(2, 4, GL_FLOAT, GL_FALSE, sizeof(Vertex), (const void*)(4 * sizeof(float)));

    std::vector<unsigned int> indices(maxQuads * 6);
    unsigned int offset = 0;
    for (size_t i = 0; i < maxQuads * 6; i += 6) {
        indices[i + 0] = offset + 0;
        indices[i + 1] = offset + 1;
        indices[i + 2] = offset + 2;
        indices[i + 3] = offset + 2;
        indices[i + 4] = offset + 3;
        indices[i + 5] = offset + 0;
        offset += 4;
    }

    glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, m_ibo);
    glBufferData(GL_ELEMENT_ARRAY_BUFFER, indices.size() * sizeof(unsigned int), indices.data(), GL_STATIC_DRAW);

    glBindVertexArray(0);

    createFontTexture();
}

QuadBatcher::~QuadBatcher() {
    glDeleteVertexArrays(1, &m_vao);
    glDeleteBuffers(1, &m_vbo);
    glDeleteBuffers(1, &m_ibo);
    glDeleteTextures(1, &m_fontTexture);
}

void QuadBatcher::createFontTexture() {
    // Create a 128x128 texture for the font
    unsigned char pixels[128 * 128];
    std::fill(pixels, pixels + 128 * 128, 0);

    for (int i = 0; i < 95; ++i) {
        int tx = (i % 16) * 8;
        int ty = (i / 16) * 8;
        for (int y = 0; y < 8; ++y) {
            unsigned char row = FONT_DATA[i][y];
            for (int x = 0; x < 8; ++x) {
                if (row & (0x80 >> x)) {
                    pixels[(ty + y) * 128 + (tx + x)] = 255;
                }
            }
        }
    }

    glGenTextures(1, &m_fontTexture);
    glBindTexture(GL_TEXTURE_2D, m_fontTexture);
    glTexImage2D(GL_TEXTURE_2D, 0, GL_RED, 128, 128, 0, GL_RED, GL_UNSIGNED_BYTE, pixels);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
    glBindTexture(GL_TEXTURE_2D, 0);
}

void QuadBatcher::begin() {
    m_quadCount = 0;
    m_vertices.clear();
}

void QuadBatcher::drawQuad(float x, float y, float w, float h, float r, float g, float b, float a) {
    if (m_quadCount >= m_maxQuads) {
        flush();
    }

    // Default mode 0 (Solid)
    m_vertices.push_back({{x, y}, {0, 0}, {r, g, b, a}});
    m_vertices.push_back({{x + w, y}, {1, 0}, {r, g, b, a}});
    m_vertices.push_back({{x + w, y + h}, {1, 1}, {r, g, b, a}});
    m_vertices.push_back({{x, y + h}, {0, 1}, {r, g, b, a}});

    m_quadCount++;
}

void QuadBatcher::drawRoundedRect(float x, float y, float w, float h, float radius, float softness, float r, float g, float b, float a) {
    flush();
    if (m_shader) {
        m_shader->setInt("mode", 2);
        m_shader->setFloat("uRadius", radius);
        m_shader->setFloat("uEdgeSoftness", softness);
        m_shader->setFloat("uSizeX", w);
        m_shader->setFloat("uSizeY", h);
    }

    // Reuse vertex coords for local space 0..1 in shader
    m_vertices.push_back({{x, y}, {0, 0}, {r, g, b, a}});
    m_vertices.push_back({{x + w, y}, {1, 0}, {r, g, b, a}});
    m_vertices.push_back({{x + w, y + h}, {1, 1}, {r, g, b, a}});
    m_vertices.push_back({{x, y + h}, {0, 1}, {r, g, b, a}});
    m_quadCount++;

    flush();
    if (m_shader) m_shader->setInt("mode", 0);
}

void QuadBatcher::drawText(const std::string& text, float x, float y, float size, float r, float g, float b, float a) {
    flush();
    if (m_shader) {
        m_shader->setInt("mode", 1);
        glBindTexture(GL_TEXTURE_2D, m_fontTexture);
    }

    float curX = x;

    for (char c : text) {
        if (c < 32 || c > 126) continue;
        int idx = c - 32;
        float tx = (float)(idx % 16) * 8.0f / 128.0f;
        float ty = (float)(idx / 16) * 8.0f / 128.0f;
        float tw = 8.0f / 128.0f;
        float th = 8.0f / 128.0f;

        m_vertices.push_back({{curX, y}, {tx, ty}, {r, g, b, a}});
        m_vertices.push_back({{curX + size, y}, {tx + tw, ty}, {r, g, b, a}});
        m_vertices.push_back({{curX + size, y + size}, {tx + tw, ty + th}, {r, g, b, a}});
        m_vertices.push_back({{curX, y + size}, {tx, ty + th}, {r, g, b, a}});

        m_quadCount++;
        curX += size;

        if (m_quadCount >= m_maxQuads) {
            flush(); 
        }
    }

    flush();
    if (m_shader) {
        m_shader->setInt("useTexture", 0);
        glBindTexture(GL_TEXTURE_2D, 0);
    }
}

void QuadBatcher::drawLine(float x1, float y1, float x2, float y2, float thickness, float r, float g, float b, float a) {
    float dx = x2 - x1;
    float dy = y2 - y1;
    if (std::abs(dx) > std::abs(dy)) {
        drawQuad(x1, y1 - thickness * 0.5f, dx, thickness, r, g, b, a);
    } else {
        drawQuad(x1 - thickness * 0.5f, y1, thickness, dy, r, g, b, a);
    }
}

void QuadBatcher::drawRect(float x, float y, float w, float h, float thickness, float r, float g, float b, float a) {
    drawQuad(x, y, w, thickness, r, g, b, a); // Top
    drawQuad(x, y + h - thickness, w, thickness, r, g, b, a); // Bottom
    drawQuad(x, y, thickness, h, r, g, b, a); // Left
    drawQuad(x + w - thickness, y, thickness, h, r, g, b, a); // Right
}

void QuadBatcher::flush() {
    if (m_quadCount == 0) return;

    glBindBuffer(GL_ARRAY_BUFFER, m_vbo);
    glBufferSubData(GL_ARRAY_BUFFER, 0, m_vertices.size() * sizeof(Vertex), m_vertices.data());

    glBindVertexArray(m_vao);
    glDrawElements(GL_TRIANGLES, (GLsizei)(m_quadCount * 6), GL_UNSIGNED_INT, 0);
    glBindVertexArray(0);

    m_quadCount = 0;
    m_vertices.clear();
}

} // namespace Beam